<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cronicle Console</title>
    <script src="./js/external/ansi_up.js"></script>
    
    <style>
        html,
        body {
            height: 100%;
        }

        body {
            background-color: #0C0C0C;
            color: #f2f2f2;
            /* background-image: radial-gradient(rgba(47, 79, 79, 0.75), black 120%); */
            font: 1rem Inconsolata, monospace;
        }

        #progress {
            position: fixed;
            z-index: 999;
            background-color: rgba(22, 22, 22, 0.90);
        }
    </style>
</head>

<body>
    <div id="progress"></div>
    <div id="console" style="padding: 10px 20px 20px 20px;"></div>

     <script>
        let ansi_up = new AnsiUp;
        // set Campbell color scheme
	    const campbellColors = {
             'ansi-black': [12, 12, 12],
             'ansi-red': [197, 15, 31],
             'ansi-green': [19, 161, 14],
             'ansi-yellow': [193, 156, 0],
             'ansi-blue': [0, 55, 218],
             'ansi-magenta': [136, 23, 152],
             'ansi-cyan': [58, 150, 221],
             'ansi-white': [204, 204, 204],
             'ansi-bright-black': [118, 118, 118],
             'ansi-bright-red': [231, 72, 86],
             'ansi-bright-green': [22, 198, 12],
             'ansi-bright-yellow': [249, 241, 165],
             'ansi-bright-blue': [59, 120, 255],
             'ansi-bright-magenta': [180, 0, 158],
             'ansi-bright-cyan': [97, 214, 214],
             'ansi-bright-white': [242, 242, 242]
         };

        ansi_up.ansi_colors.forEach(colorGroup => {
          colorGroup.forEach(color => {
            if (campbellColors[color.class_name]) {
              color.rgb = campbellColors[color.class_name];
            }
          });
        });

        let invalidJobError = `<span style="color:red"><b>Invalid job id </b></span>`
        let prog = document.getElementById('progress');
        let validId = false;
        let query = location.search
        webConsole = document.getElementById('console');
        let qParams = new URLSearchParams(query)

    function trimAnimation(line) {
        let homeMatch =  line.split(/\x1b\[(?:1[;\d]*|)H/).at(-1) // catch "return home" sequence
		if(homeMatch) line = homeMatch        
		// if(line.indexOf('\x1b[H') > -1) return line.substring(line.lastIndexOf("\x1b[H") + 3); // line has "return to home" character, that should be animation
        if (line.endsWith("\x1B[0K\x1B[0m\x1B[m")) return line; // used by git diff / delta for row highlight
        if (line.indexOf("\x1b[0K") > -1) return line.substring(line.lastIndexOf("\x1b[0K") + 4);
		if (line.indexOf("\x1b[K\r") > -1) return line.substring(line.lastIndexOf("\x1b[K\r") + 4); // windows version of [0K
        if (line.trimEnd().indexOf("\r") > -1) return line.substring(line.trimEnd().lastIndexOf("\r"));
        return line;
      }

        function refresh() {
            fetch('./api/app/get_live_console' + query + '&session_id=' + localStorage.session_id)
                .then(response => {
                    response.json().then(data => {
                        if (data.data) {
                            if (!validId) validId = true;
                             webConsole.innerHTML = `<pre>${ansi_up.ansi_to_html(data.data.replace(/\u001B=/g, ''))} </pre>`;
                            if(qParams.get('download') == 1) return; // if download=1 stop polling (just print entire log)
                            prog.innerHTML = `<span style="color:green">
                                <b>In progress:  ${data.event_title} on ${data.hostname} </b> -
                                ${(new Date()).toLocaleString()}
                            </span>`
                        } 
                        else if(data.code == 'api' || data.code == 'session') {
                            webConsole.innerHTML = '<span style="color:red">Unauthorized, you will be redirected to login page shortly</span>';
                            setTimeout(()=>{window.location.href = '/'}, 1000)
                            return;
                        }
                        else {
                            // if no live log data check history and return
                            fetch('./api/app/get_job_log' + query + '&session_id=' + localStorage.session_id).then(
                                //if( response.status == 200) { }
                                response => response.text().then(data => {
                                    if (response.status == 200) {
                                        if(data.lastIndexOf('\x1b[2J') > -1) {
                                            data = '\n\n\n\n\n' + data.substring(data.lastIndexOf('\x1b[2J') + 4)
                                        }
                                        data = data.split(/\r?\n/)
                                            .slice(4, -4)
                                            .map(trimAnimation)
                                            .join("\n")
                                            .replace(/\x1b\][^\x07]*\x07/g, "") // OSC sequences ending with BEL
                                            .replace(/\x1b\][^\x1b]*\x1b\\/g, "") // OSC sequences ending with ST
                                            .replace(/\x1b\[\?25h/g, "") // Show cursor
                                            .replace(/\x1b\[\?25l/g, "") // Hide cursor;
                                            .replace(/\u001B=/g, "") // removing Esc= sequence generated by powershell pipe
                                            .replace(/\x1b\[(\d+)C/g, (match, n) => {
                                                // parse cursor movement character, e.g. [20C => 20 spaces
                                                return " ".repeat(parseInt(n));
                                            });
                                        webConsole.innerHTML = '<pre>' + ansi_up.ansi_to_html(data) + '</pre>';
                                    }
                                    else { webConsole.innerHTML = invalidJobError; }

                                }))
                            if (validId) prog.innerHTML = `<span style="color:green"><b>Completed:</b> ${(new Date()).toLocaleString()}</span>`
                            return;
                        }
                        setTimeout(refresh, 1000);
                    });
                }
                )
                .catch(function (err) {
                    webConsole.innerHTML = invalidJobError;
                });
        }

        refresh();

    </script>

</body>

</html>